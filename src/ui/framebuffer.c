#include "ui/framebuffer.h"

#include <stddef.h>
#include <stdint.h>

#define FB_MAX_WIDTH 1024
#define FB_MAX_HEIGHT 768

typedef struct {
    framebuffer_info_t hw;
    int present;
} framebuffer_state_t;

typedef struct {
    uint32_t cols;
    uint32_t rows;
    uint32_t cell_w;
    uint32_t cell_h;
    uint32_t origin_x;
    uint32_t origin_y;
    uint32_t glyph_scale;
    int configured;
    int active;
    int visible;
} framebuffer_console_state_t;

static framebuffer_state_t fb = {0};
static framebuffer_console_state_t fb_console = {0};

static uint32_t fb_backbuffer[FB_MAX_WIDTH * FB_MAX_HEIGHT];
static uint32_t fb_buf_width = 0;
static uint32_t fb_buf_height = 0;

static const uint32_t vga_palette[16] = {
    0xFF000000, 0xFFAA0000, 0xFF00AA00, 0xFFAA5500,
    0xFF0000AA, 0xFFAA00AA, 0xFF00AAAA, 0xFFAAAAAA,
    0xFF555555, 0xFFFF5555, 0xFF55FF55, 0xFFFFFF55,
    0xFF5555FF, 0xFFFF55FF, 0xFF55FFFF, 0xFFFFFFFF
};

/* font8x8_basic is public-domain data from https://github.com/dhepper/font8x8 */
static const uint8_t font8x8_basic[128][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, /* U+0000 */
    {0x7E,0x81,0xA5,0x81,0xBD,0x99,0x81,0x7E}, /* U+0001 */
    {0x7E,0xFF,0xDB,0xFF,0xC3,0xE7,0xFF,0x7E}, /* U+0002 */
    {0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00}, /* U+0003 */
    {0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00}, /* U+0004 */
    {0x38,0x7C,0x38,0xFE,0xFE,0xD6,0x10,0x38}, /* U+0005 */
    {0x10,0x38,0x7C,0xFE,0xFE,0x7C,0x10,0x38}, /* U+0006 */
    {0x00,0x00,0x18,0x3C,0x3C,0x18,0x00,0x00}, /* U+0007 */
    {0xFF,0xFF,0xE7,0xC3,0xC3,0xE7,0xFF,0xFF}, /* U+0008 */
    {0x00,0x3C,0x66,0x42,0x42,0x66,0x3C,0x00}, /* U+0009 */
    {0xFF,0xC3,0x99,0xBD,0xBD,0x99,0xC3,0xFF}, /* U+000A */
    {0x0F,0x07,0x0F,0x7D,0xCC,0xCC,0xCC,0x78}, /* U+000B */
    {0x3C,0x66,0x66,0x66,0x3C,0x18,0x7E,0x18}, /* U+000C */
    {0x3F,0x33,0x3F,0x30,0x30,0x70,0xF0,0xE0}, /* U+000D */
    {0x7F,0x63,0x7F,0x63,0x63,0x67,0xE6,0xC0}, /* U+000E */
    {0x99,0x5A,0x3C,0xE7,0xE7,0x3C,0x5A,0x99}, /* U+000F */
    {0x80,0xE0,0xF8,0xFE,0xF8,0xE0,0x80,0x00}, /* U+0010 */
    {0x02,0x0E,0x3E,0xFE,0x3E,0x0E,0x02,0x00}, /* U+0011 */
    {0x18,0x3C,0x7E,0x18,0x18,0x7E,0x3C,0x18}, /* U+0012 */
    {0x66,0x66,0x66,0x66,0x66,0x00,0x66,0x00}, /* U+0013 */
    {0x7F,0xDB,0xDB,0x7B,0x1B,0x1B,0x1B,0x00}, /* U+0014 */
    {0x3E,0x63,0x38,0x6C,0x6C,0x38,0xC6,0x7C}, /* U+0015 */
    {0x00,0x00,0x00,0x00,0x7E,0x7E,0x7E,0x00}, /* U+0016 */
    {0x18,0x3C,0x7E,0x18,0x7E,0x3C,0x18,0xFF}, /* U+0017 */
    {0x18,0x3C,0x7E,0x18,0x18,0x18,0x18,0x00}, /* U+0018 */
    {0x18,0x18,0x18,0x18,0x7E,0x3C,0x18,0x00}, /* U+0019 */
    {0x00,0x18,0x0C,0xFE,0x0C,0x18,0x00,0x00}, /* U+001A */
    {0x00,0x30,0x60,0xFE,0x60,0x30,0x00,0x00}, /* U+001B */
    {0x00,0x00,0xC0,0xC0,0xC0,0xFE,0x00,0x00}, /* U+001C */
    {0x00,0x24,0x66,0xFF,0x66,0x24,0x00,0x00}, /* U+001D */
    {0x00,0x18,0x3C,0x7E,0xFF,0xFF,0x00,0x00}, /* U+001E */
    {0x00,0xFF,0xFF,0x7E,0x3C,0x18,0x00,0x00}, /* U+001F */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, /*   */
    {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00}, /* ! */
    {0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00}, /* " */
    {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00}, /* # */
    {0x18,0x7E,0xC0,0x7C,0x06,0xFC,0x18,0x00}, /* $ */
    {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00}, /* % */
    {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00}, /* & */
    {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00}, /* ' */
    {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00}, /* ( */
    {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00}, /* ) */
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, /* * */
    {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00}, /* + */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, /* , */
    {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00}, /* - */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, /* . */
    {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00}, /* / */
    {0x7C,0xC6,0xCE,0xDE,0xF6,0xE6,0x7C,0x00}, /* 0 */
    {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00}, /* 1 */
    {0x7C,0xC6,0x0E,0x1C,0x70,0xC0,0xFE,0x00}, /* 2 */
    {0x7C,0xC6,0x06,0x3C,0x06,0xC6,0x7C,0x00}, /* 3 */
    {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00}, /* 4 */
    {0xFE,0xC0,0xFC,0x06,0x06,0xC6,0x7C,0x00}, /* 5 */
    {0x3C,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00}, /* 6 */
    {0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00}, /* 7 */
    {0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00}, /* 8 */
    {0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00}, /* 9 */
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00}, /* : */
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30}, /* ; */
    {0x0E,0x1C,0x38,0x70,0x38,0x1C,0x0E,0x00}, /* < */
    {0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00}, /* = */
    {0x70,0x38,0x1C,0x0E,0x1C,0x38,0x70,0x00}, /* > */
    {0x7C,0xC6,0x0E,0x1C,0x18,0x00,0x18,0x00}, /* ? */
    {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x7C,0x00}, /* @ */
    {0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0x00}, /* A */
    {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00}, /* B */
    {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00}, /* C */
    {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00}, /* D */
    {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00}, /* E */
    {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00}, /* F */
    {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3A,0x00}, /* G */
    {0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00}, /* H */
    {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, /* I */
    {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00}, /* J */
    {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00}, /* K */
    {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00}, /* L */
    {0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00}, /* M */
    {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00}, /* N */
    {0x38,0x6C,0xC6,0xC6,0xC6,0x6C,0x38,0x00}, /* O */
    {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00}, /* P */
    {0x7C,0xC6,0xC6,0xC6,0xD6,0xCC,0x7A,0x00}, /* Q */
    {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00}, /* R */
    {0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00}, /* S */
    {0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00}, /* T */
    {0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00}, /* U */
    {0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00}, /* V */
    {0xC6,0xC6,0xD6,0xFE,0xFE,0xEE,0xC6,0x00}, /* W */
    {0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00}, /* X */
    {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00}, /* Y */
    {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00}, /* Z */
    {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00}, /* [ */
    {0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00}, /* \ */
    {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00}, /* ] */
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00}, /* ^ */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, /* _ */
    {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00}, /* ` */
    {0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00}, /* a */
    {0xE0,0x60,0x60,0x7C,0x66,0x66,0xDC,0x00}, /* b */
    {0x00,0x00,0x7C,0xC6,0xC0,0xC6,0x7C,0x00}, /* c */
    {0x1C,0x0C,0x0C,0x7C,0xCC,0xCC,0x76,0x00}, /* d */
    {0x00,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00}, /* e */
    {0x1C,0x36,0x30,0x7C,0x30,0x30,0x78,0x00}, /* f */
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8}, /* g */
    {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00}, /* h */
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00}, /* i */
    {0x06,0x00,0x06,0x06,0x06,0x66,0x66,0x3C}, /* j */
    {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00}, /* k */
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, /* l */
    {0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xC6,0x00}, /* m */
    {0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00}, /* n */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0x00}, /* o */
    {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0}, /* p */
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E}, /* q */
    {0x00,0x00,0xDC,0x76,0x66,0x60,0xF0,0x00}, /* r */
    {0x00,0x00,0x7E,0xC0,0x7C,0x06,0xFC,0x00}, /* s */
    {0x30,0x30,0xFC,0x30,0x30,0x36,0x1C,0x00}, /* t */
    {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00}, /* u */
    {0x00,0x00,0xC6,0xC6,0x6C,0x38,0x10,0x00}, /* v */
    {0x00,0x00,0xC6,0xD6,0xFE,0xEE,0xC6,0x00}, /* w */
    {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00}, /* x */
    {0x00,0x00,0xC6,0xC6,0xCE,0x7E,0x06,0xFC}, /* y */
    {0x00,0x00,0xFE,0x8C,0x18,0x32,0xFE,0x00}, /* z */
    {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00}, /* { */
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, /* | */
    {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00}, /* } */
    {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00}, /* ~ */
    {0x10,0x38,0x6C,0xC6,0xC6,0xFE,0x00,0x00} /* DEL */
};

static inline uint32_t pack_color(uint8_t r, uint8_t g, uint8_t b)
{
    return 0xFF000000u | ((uint32_t)r << 16) | ((uint32_t)g << 8) | (uint32_t)b;
}

static inline void backbuffer_put_pixel(uint32_t x, uint32_t y, uint32_t color)
{
    if (x >= fb_buf_width || y >= fb_buf_height) {
        return;
    }
    fb_backbuffer[y * FB_MAX_WIDTH + x] = color;
}

static void backbuffer_clear(uint32_t color)
{
    if (fb_buf_width == 0 || fb_buf_height == 0) {
        return;
    }
    for (uint32_t y = 0; y < fb_buf_height; ++y) {
        uint32_t *row = &fb_backbuffer[y * FB_MAX_WIDTH];
        for (uint32_t x = 0; x < fb_buf_width; ++x) {
            row[x] = color;
        }
    }
}

static void backbuffer_blit_to_hw(void)
{
    if (!fb.present || fb_buf_width == 0 || fb_buf_height == 0) {
        return;
    }
    uint32_t width_bytes = fb_buf_width * sizeof(uint32_t);
    for (uint32_t y = 0; y < fb_buf_height; ++y) {
        uint8_t *dest = fb.hw.addr + y * fb.hw.pitch;
        const uint8_t *src = (const uint8_t *)&fb_backbuffer[y * FB_MAX_WIDTH];
        for (uint32_t i = 0; i < width_bytes; ++i) {
            dest[i] = src[i];
        }
    }
}

static inline uint32_t bpp_bytes(void)
{
    return fb.hw.bpp / 8;
}

static void framebuffer_draw_glyph(uint32_t x, uint32_t y, char c, uint32_t fg, uint32_t bg, uint32_t scale)
{
    const uint8_t *glyph = font8x8_basic[(uint8_t)c];
    if (scale == 0) {
        scale = 1;
    }
    for (uint32_t row = 0; row < 8; ++row) {
        uint8_t bits = glyph[row];
        uint32_t py = y + row * scale;
        for (uint32_t col = 0; col < 8; ++col) {
            uint32_t mask = 0x80u >> col; /* leftmost bit corresponds to col 0 */
            uint32_t color = (bits & mask) ? fg : bg;
            uint32_t px = x + col * scale;
            for (uint32_t dy = 0; dy < scale; ++dy) {
                for (uint32_t dx = 0; dx < scale; ++dx) {
                    framebuffer_draw_pixel(px + dx, py + dy, color);
                }
            }
        }
    }
}

void framebuffer_init(multiboot_info_t *mb_info)
{
    fb.present = 0;
    if (!mb_info) {
        return;
    }
    if (!(mb_info->flags & (1u << 12))) {
        return;
    }
    if (mb_info->framebuffer_type != 1 || mb_info->framebuffer_bpp != 32) {
        return;
    }
    fb.hw.addr = (uint8_t *)((uintptr_t)mb_info->framebuffer_addr);
    fb.hw.width = mb_info->framebuffer_width;
    fb.hw.height = mb_info->framebuffer_height;
    fb.hw.pitch = mb_info->framebuffer_pitch;
    fb.hw.bpp = mb_info->framebuffer_bpp;
    fb_buf_width = fb.hw.width;
    if (fb_buf_width > FB_MAX_WIDTH) {
        fb_buf_width = FB_MAX_WIDTH;
    }
    fb_buf_height = fb.hw.height;
    if (fb_buf_height > FB_MAX_HEIGHT) {
        fb_buf_height = FB_MAX_HEIGHT;
    }
    backbuffer_clear(0);
    fb.present = 1;
}

int framebuffer_available(void)
{
    return fb.present;
}

const framebuffer_info_t *framebuffer_query(void)
{
    if (!fb.present) {
        return NULL;
    }
    return &fb.hw;
}

void framebuffer_present(void)
{
    backbuffer_blit_to_hw();
}

void framebuffer_draw_pixel(uint32_t x, uint32_t y, uint32_t color)
{
    if (!fb.present) {
        return;
    }
    backbuffer_put_pixel(x, y, color);
}

void framebuffer_clear(uint32_t color)
{
    if (!fb.present) {
        return;
    }
    backbuffer_clear(color);
}

void framebuffer_draw_rect(uint32_t x, uint32_t y, uint32_t w, uint32_t h, uint32_t color)
{
    if (!fb.present || fb_buf_width == 0 || fb_buf_height == 0) {
        return;
    }
    if (x >= fb_buf_width || y >= fb_buf_height) {
        return;
    }
    if (x + w > fb_buf_width) {
        w = fb_buf_width - x;
    }
    if (y + h > fb_buf_height) {
        h = fb_buf_height - y;
    }
    if (w == 0 || h == 0) {
        return;
    }
    for (uint32_t yy = 0; yy < h; ++yy) {
        uint32_t *row = &fb_backbuffer[(y + yy) * FB_MAX_WIDTH];
        for (uint32_t xx = 0; xx < w; ++xx) {
            row[x + xx] = color;
        }
    }
}

void framebuffer_draw_char(uint32_t x, uint32_t y, char c, uint32_t fg, uint32_t bg)
{
    if (!fb.present) {
        return;
    }
    framebuffer_draw_glyph(x, y, c, fg, bg, 1);
}

void framebuffer_draw_text(uint32_t x, uint32_t y, const char *text, uint32_t fg, uint32_t bg)
{
    framebuffer_draw_text_scaled(x, y, text, fg, bg, 1);
}

void framebuffer_draw_text_scaled(uint32_t x, uint32_t y, const char *text, uint32_t fg, uint32_t bg, uint32_t scale)
{
    if (!fb.present || !text) {
        return;
    }
    uint32_t cursor_x = x;
    while (*text) {
        if (*text == '\n') {
            y += 8 * scale;
            cursor_x = x;
        } else {
            framebuffer_draw_glyph(cursor_x, y, *text, fg, bg, scale);
            cursor_x += 8 * scale + scale;
        }
        ++text;
    }
}

void framebuffer_blit_sprite(uint32_t x, uint32_t y, uint32_t w, uint32_t h, const uint32_t *pixels, int skip_zero)
{
    if (!fb.present || !pixels) {
        return;
    }
    for (uint32_t row = 0; row < h; ++row) {
        for (uint32_t col = 0; col < w; ++col) {
            uint32_t color = pixels[row * w + col];
            if (skip_zero && color == 0) {
                continue;
            }
            framebuffer_draw_pixel(x + col, y + row, color);
        }
    }
}

void framebuffer_console_configure(uint32_t cols, uint32_t rows)
{
    if (!fb.present) {
        return;
    }
    fb_console.cols = cols;
    fb_console.rows = rows;
    fb_console.glyph_scale = 2;
    fb_console.cell_w = 8 * fb_console.glyph_scale;
    fb_console.cell_h = 8 * fb_console.glyph_scale;
    uint32_t console_width_px = fb_console.cell_w * cols;
    uint32_t console_height_px = fb_console.cell_h * rows;
    uint32_t width = fb_buf_width ? fb_buf_width : fb.hw.width;
    uint32_t height = fb_buf_height ? fb_buf_height : fb.hw.height;
    fb_console.origin_x = (width > console_width_px)
                              ? (width - console_width_px) / 2
                              : 0;
    fb_console.origin_y = (height > console_height_px + 32)
                              ? (height - console_height_px - 24)
                              : 0;
    fb_console.visible = 1;
    fb_console.configured = 1;
}

int framebuffer_console_attach(void)
{
    if (!fb.present || !fb_console.configured) {
        return 0;
    }
    fb_console.active = 1;
    return 1;
}

void framebuffer_console_set_visible(int visible)
{
    fb_console.visible = visible && fb_console.active;
}

int framebuffer_console_visible(void)
{
    return fb_console.active && fb_console.visible;
}

void framebuffer_console_bounds(uint32_t *x, uint32_t *y, uint32_t *w, uint32_t *h)
{
    if (!fb_console.configured) {
        if (x) *x = 0;
        if (y) *y = 0;
        if (w) *w = 0;
        if (h) *h = 0;
        return;
    }
    if (x) *x = fb_console.origin_x;
    if (y) *y = fb_console.origin_y;
    if (w) *w = fb_console.cols * fb_console.cell_w;
    if (h) *h = fb_console.rows * fb_console.cell_h;
}

static uint32_t attr_to_color(uint8_t attr, int foreground)
{
    uint8_t idx = foreground ? (attr & 0x0F) : ((attr >> 4) & 0x0F);
    return vga_palette[idx & 0x0F];
}

void framebuffer_console_draw_cell(uint32_t col, uint32_t row, char c, uint8_t attr)
{
    if (!fb_console.active || !fb_console.visible) {
        return;
    }
    if (col >= fb_console.cols || row >= fb_console.rows) {
        return;
    }
    uint32_t fg = attr_to_color(attr, 1);
    uint32_t bg = attr_to_color(attr, 0);
    uint32_t x = fb_console.origin_x + col * fb_console.cell_w;
    uint32_t y = fb_console.origin_y + row * fb_console.cell_h;
    framebuffer_draw_rect(x, y, fb_console.cell_w, fb_console.cell_h, bg);
    framebuffer_draw_glyph(x, y, c, fg, bg, fb_console.glyph_scale);
}

void framebuffer_console_full_refresh(const uint16_t *buffer, uint32_t cols, uint32_t rows)
{
    if (!buffer || !fb_console.active || !fb_console.visible) {
        return;
    }
    if (cols != fb_console.cols || rows != fb_console.rows) {
        cols = fb_console.cols;
        rows = fb_console.rows;
    }
    for (uint32_t row = 0; row < rows; ++row) {
        for (uint32_t col = 0; col < cols; ++col) {
            uint16_t entry = buffer[row * cols + col];
            framebuffer_console_draw_cell(col, row, (char)(entry & 0xFF), (uint8_t)(entry >> 8));
        }
    }
}

void framebuffer_render_splash(const char *version)
{
    if (!fb.present || fb_buf_width == 0 || fb_buf_height == 0) {
        return;
    }

    for (uint32_t y = 0; y < fb_buf_height; ++y) {
        uint8_t mix = (uint8_t)((y * 64) / fb_buf_height);
        uint32_t color = pack_color(8 + mix, 12 + mix / 2, 24 + mix);
        for (uint32_t x = 0; x < fb_buf_width; ++x) {
            backbuffer_put_pixel(x, y, color);
        }
    }

    for (uint32_t y = 0; y < fb_buf_height; ++y) {
        uint32_t stripe_x_start = (uint32_t)((int32_t)y / 2);
        if (stripe_x_start < fb_buf_width) {
            uint32_t width = fb_buf_width / 3;
            if (stripe_x_start + width > fb_buf_width) {
                width = fb_buf_width - stripe_x_start;
            }
            framebuffer_draw_rect(stripe_x_start, y, width, 1, 0xFF143D59);
        }
    }

    framebuffer_draw_rect(0, 0, fb_buf_width, 96, 0xFF0F1923);

    static const char *sprite_rows[] = {
        "................",
        "......11........",
        ".....1221.......",
        "....122221......",
        "...12222221.....",
        "...12233321.....",
        "..1223333321....",
        "..1223333321....",
        "..1223333321....",
        "..01233333210...",
        "...012222210....",
        "....0122210.....",
        ".....01110......",
        "......000.......",
        "......000.......",
        ".....00000......"
    };

    uint32_t sprite_w = 16;
    uint32_t sprite_h = (uint32_t)(sizeof(sprite_rows) / sizeof(sprite_rows[0]));
    uint32_t sprite_pixels[16 * 16];
    for (uint32_t row = 0; row < sprite_h; ++row) {
        const char *line = sprite_rows[row];
        for (uint32_t col = 0; col < sprite_w; ++col) {
            char ch = line[col];
            uint32_t color = 0;
            switch (ch) {
            case '1':
                color = 0xFF0EA5E9;
                break;
            case '2':
                color = 0xFF22D3EE;
                break;
            case '3':
                color = 0xFF67E8F9;
                break;
            case '0':
                color = 0xFFFFFFFF;
                break;
            default:
                color = 0;
                break;
            }
            sprite_pixels[row * sprite_w + col] = color;
        }
    }
    framebuffer_blit_sprite(72, 140, sprite_w, sprite_h, sprite_pixels, 1);

    framebuffer_draw_text_scaled(120, 120, "PenOS", 0xFFE5E7EB, 0x00000000, 3);
    framebuffer_draw_text(120, 200, "Preemptive 32-bit kernel playground", 0xFFCBD5F5, 0x00000000);
    framebuffer_draw_text(120, 220, "Keyboard + mouse drivers ready for GUI work", 0xFF64748B, 0x00000000);
    if (version) {
        framebuffer_draw_text(120, 250, version, 0xFF38BDF8, 0x00000000);
    }

    uint32_t cx, cy, cw, ch;
    framebuffer_console_bounds(&cx, &cy, &cw, &ch);
    if (cw > 0 && ch > 0) {
        framebuffer_draw_rect(cx - 8, cy - 8, cw + 16, ch + 16, 0xAA0B1119);
        framebuffer_draw_rect(cx, cy, cw, ch, 0xCC050C16);
    }

    framebuffer_present();
}
