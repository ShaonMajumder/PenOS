# PenOS v0.9.0 - Demand Paging Release

**Release Date:** November 30, 2025  
**Codename:** Lazy Allocator

## Overview

Version 0.9.0 introduces **demand paging**, a critical memory management feature that enables lazy allocation of user-space memory. This release also includes important bug fixes to the VirtIO-9P filesystem driver and build system improvements.

## Major Features

### Demand Paging

PenOS now implements demand paging through a page fault handler that intercepts interrupt 14 (Page Fault Exception). When a user-mode process accesses an unmapped page, the system automatically allocates and maps a physical frame instead of crashing.

**Key Benefits:**
- **Lazy Allocation**: Memory is only allocated when actually accessed, reducing memory waste
- **Improved Efficiency**: Processes can reserve large address spaces without immediately consuming physical memory
- **Foundation for Advanced Features**: Enables future implementation of:
  - Copy-on-write (COW) for efficient `fork()`
  - Memory-mapped files
  - Swap space and page replacement algorithms

**Technical Details:**
- Page fault handler registered for interrupt 14
- Checks for non-present pages in user mode (error code analysis)
- Allocates zero-filled physical frames on-demand
- Maps pages with `PAGE_PRESENT | PAGE_RW | PAGE_USER` flags
- Modified exception dispatcher to allow handlers before panicking

**Files Modified:**
- `src/mem/paging.c` - Added `page_fault_handler()`
- `src/arch/x86/interrupts.c` - Updated exception dispatching
- `include/mem/paging.h` - No changes needed (uses existing API)

## Bug Fixes

### VirtIO-9P Filesystem Driver

Fixed compilation errors and missing functionality in the 9P filesystem driver:

- **Implemented `p9_read()`**: Added missing function to read file data
- **Improved `p9_get_file_size()`**: Now uses proper TGETATTR (9P2000.L) instead of estimation
- **Code Consolidation**: Merged duplicate code from `9p_fileread.c` into main driver
- **Cleanup**: Removed redundant `src/fs/9p_fileread.c` file

### Build System

- **Added ELF Loader**: Added `elf.o` to Makefile linker command to fix undefined reference errors
- **Scheduler Headers**: Fixed missing includes in `src/sched/sched.c`
- **Shell Syntax**: Fixed misplaced braces and preprocessor directives in `src/shell/shell.c`

## Documentation

### New Documentation
- `docs/commits/feature-paging/2_demand_paging.md` - Detailed demand paging implementation guide
- `docs/commits/feature-paging/commit_summary_2025-11-30.md` - Comprehensive commit summary

### Updated Documentation
- `README.md` - Added Demand Paging to feature list and memory management section
- `CHANGELOG.md` - Added v0.9.0 entry
- `VERSION` - Updated to 0.9.0

## Testing

To test demand paging:

1. Build and run PenOS:
   ```bash
   make clean && make iso && sudo make run
   ```

2. Spawn a user-mode task:
   ```
   PenOS:/> usermode
   ```

3. The task will access unmapped memory, triggering the page fault handler
4. Pages should be allocated automatically without crashes

## Known Issues

None specific to this release.

## Upgrade Notes

This is a feature release with no breaking changes. Existing functionality remains unchanged.

## Performance

Demand paging introduces minimal overhead:
- Page fault handling adds ~1000 CPU cycles per first access
- Subsequent accesses have zero overhead (page is already mapped)
- Overall memory efficiency improved due to lazy allocation

## Statistics

- **Commits**: 5 (849040d, d939bc4, 7073913, 1aed32e, 62563dd)
- **Files Changed**: 8
- **Lines Added**: ~150
- **Lines Removed**: ~160
- **New Features**: 1 (Demand Paging)
- **Bug Fixes**: 4

## Contributors

- Shaon Majumder

## Next Steps

Future releases will build on demand paging to implement:
- Copy-on-write (COW) for `fork()`
- Memory-mapped files
- Swap space support
- Page replacement algorithms (LRU, FIFO, Clock)
- Shared memory for IPC

## References

- [Demand Paging Documentation](../commits/feature-paging/2_demand_paging.md)
- [Commit Summary](../commits/feature-paging/commit_summary_2025-11-30.md)
- [README](../../README.md)
